#!/bin/bash
# http://jamie.curle.io/blog/compiling-nginx-ubuntu/
# https://github.com/cloudfoundry-community/nginx-buildpack#building-the-nginx-package

set -e #halt on any error

pcre_version=8.37
pcre_url="ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-${pcre_version}.tar.gz"
pcre_filename=$(basename "${pcre_url}")
pcre_dirname="${pcre_filename%.tar.gz}"

nginx_version=1.7.4
nginx_url="http://nginx.org/download/nginx-${nginx_version}.tar.gz"
nginx_filename=$(basename "${nginx_url}")
nginx_dirname="${nginx_filename%.tar.gz}"

release=$(lsb_release -cs)
sudo apt-get update
sudo apt-get install -fy build-essential zlib1g-dev

if [ "${release}" = "trusty" ]; then
    # We need libssl-dev to compile nginx on trusty
    sudo apt-get install -fy libssl-dev
fi


src=~/src
build=/app/nginx
target=/vagrant/vendor

sudo rm -rf "${build}" && sudo mkdir -p "${build}" && sudo chown -R vagrant:vagrant "${build}"
mkdir -p "${src}"
pushd "${src}"

  wget --no-verbose "${pcre_url}"
  tar -xzvf "${pcre_filename}"
  pushd "${pcre_dirname}"
    ./configure --prefix="${build}"
    make
    sudo make install
    sudo ldconfig # this is important otherwise nginx will compile but fail to load
  popd

  wget --no-verbose "${nginx_url}"
  tar -xvzf "${nginx_filename}"
  pushd "${nginx_dirname}"
    ./configure --prefix="${build}" --with-pcre="${src}/${pcre_dirname}" --with-http_ssl_module --with-http_gzip_static_module
    make
    sudo make install

    # Remove extras (help, utilities etc)

    sudo rm -rf /app/nginx/bin
    sudo rm -rf /app/nginx/sbin/nginx.old
    sudo rm -rf /app/nginx/include
    sudo rm -rf /app/nginx/share/man

    # Ensure we include the licenses in the tarball

    # PCRE license is in /app/nginx/share/doc/pcre/LICENCE
    # Put Nginx license is in /app/nginx/share/doc/nginx
    sudo mkdir -p /app/nginx/share/doc/nginx
    sudo cp "${src}/${nginx_dirname}"/{LICENSE,CHANGES,README} /app/nginx/share/doc/nginx

    # Archive it all up
    mkdir -p "${target}"
  popd
popd

pushd /app
  tar -zcvpf "${target}/nginx-${nginx_version}-${release}.tar.gz" nginx/
popd
